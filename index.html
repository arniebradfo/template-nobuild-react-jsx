<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>No-Build React JSX Demo</title>

  <style>
    * {
      font-family: sans-serif;
    }
  </style>

  <!-- Import map for React dependencies -->
  <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@19.1.0",
            "react-dom/": "https://esm.sh/react-dom@19.1.0/"
        }
    }
  </script>

  <!-- Register service worker and wait for it to be ready -->
  <script defer>
    async function startApp() {
      if ('serviceWorker' in navigator) {
        try {

          const registration = await navigator.serviceWorker.register('./service-worker.js');
          console.log('Service Worker registered:', registration);

          // Wait for service worker to be ready and controlling this page
          await navigator.serviceWorker.ready;

          // If there's already a controller, we're good to go
          // If not, wait for the controllerchange event
          if (navigator.serviceWorker.controller) {
            loadReactApp();
          } else {
            console.log("here")
            // in the case of a force-refresh, the cache is disabled, so the service worker will never run.
            // https://stackoverflow.com/a/49076667/5648839
            // in this case, we reload the page after a short delay.
            const reloadTimeout = setTimeout(() => location.reload(), 1000);
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              clearTimeout(reloadTimeout);
              loadReactApp();
            });
          }
        } catch (error) {
          console.error('Service Worker registration failed:', error);
          // Fallback: try to load app anyway
          loadReactApp();
        }
      } else {
        console.error('Service Workers not supported');
        loadReactApp();
      }
    }

    async function loadReactApp() {
      // Import the app loader only after service worker is ready
      // This ensures ALL JSX imports happen after SW is controlling
      await import('./app-loader.js');
    }

    // Start the process
    startApp();
  </script>
</head>

<body>
  <div id="root">
    <p><strong>Loading...</strong></p>
  </div>
</body>

</html>